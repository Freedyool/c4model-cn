---
layout: doc
title: 微服务
---

# 微服务

广义上讲，使用C4模型绘制微服务有两种选择，尽管这取决于你对“微服务”的定义。考虑到这一点，让我们从头开始。

## 阶段1 - 单体架构风格

假设我们在一家资金紧张的小型初创公司工作，我们的任务是构建一个软件系统（名为“X”），为我们的客户提供业务能力A、B和C。我们的系统上下文图可能如下所示：

[![](/images/microservices/1.png)](/images/microservices/1.png)

可以说，特别是对于一个资金紧张、工程团队规模较小的初创公司来说，最快和最便宜的交付方式是使用单体架构，由一个单体Web应用程序组成，读取和写入单一的单体数据库模式。生成的容器图如下所示：

[![](/images/microservices/2.png)](/images/microservices/2.png)

## 阶段2 - 微服务架构风格

几年过去了——我们有了一些付费客户，流量开始增加，我们雇佣了更多的工程师，代码库也在增长。我们的单体架构开始拖慢我们的速度，因此我们决定转向微服务架构。这引出了一个问题——什么是微服务？

为了回答这个问题，我们参考了James Lewis和Martin Fowler撰写的[微服务](https://martinfowler.com/articles/microservices.html)：

> 简而言之，微服务架构风格是一种将单个应用程序开发为一组小型服务的方法，每个服务在自己的进程中运行，并通过轻量级机制（通常是HTTP资源API）进行通信。这些服务围绕业务能力构建，并通过完全自动化的部署机制独立部署。

为了帮助我们将其与C4模型对齐，让我们将“应用程序”替换为“软件系统”：

> 简而言之，微服务架构风格是一种将单个__软件系统__开发为一组小型服务的方法，每个服务在自己的进程中运行，并通过轻量级机制（通常是HTTP资源API）进行通信。这些服务围绕业务能力构建，并通过完全自动化的部署机制独立部署。

在我们初创公司的这一阶段，尽管我们雇佣了更多的工程师，但我们决定保持单一团队。我们的系统上下文图保持不变：

[![](/images/microservices/3.png)](/images/microservices/3.png)

但我们的容器图发生了变化。我们决定保留现有Web应用程序的单一单体UI，但将业务逻辑和数据移到各个微服务中。生成的容器图现在如下所示：

[![](/images/microservices/4.png)](/images/microservices/4.png)

由于我们仍然是一个单一的工程团队，转向微服务架构只是团队边界内显而易见的实现细节。这就是为什么所有七个容器都显示在软件系统边界内，每个“微服务”都是API容器（六边形）和数据库模式容器（圆柱体）的组合。因此，你会注意到这个容器图没有将微服务显示为明确的框。相反，这个版本的图使用颜色编码来显示API和数据库模式容器之间的关系。如果你想更明确地表示这种配对，可以在每对周围画一个框，以显示它们是分组在一起的。

[![](/images/microservices/5.png)](/images/microservices/5.png)

现在假设我们要扩展我们的软件系统的范围，以包括业务能力D。修订后的系统上下文图如下所示：

[![](/images/microservices/6.png)](/images/microservices/6.png)

如果新的业务能力由一个新的微服务实现，而这个微服务只是一个无状态的AWS lambda，修订后的容器图如下所示：

[![](/images/microservices/7.png)](/images/microservices/7.png)

## 阶段3 - 康威定律

随着我们的公司成长，从初创公司转变为规模化公司，我们开始寻找优化交付的方法，并决定参考[康威定律](https://en.wikipedia.org/wiki/Conway%27s_law)。总之，我们决定将单一的工程团队拆分为多个团队，结果是每个微服务将由一个单独的团队拥有：

- 团队X：拥有提供与业务能力A、B、C和D相关的UI的软件系统X。
- 团队A：拥有服务A。
- 团队B：拥有服务B。
- 团队C：拥有服务C。
- 团队D：拥有服务D。

我们现在可以使用C4模型从拥有它的团队的角度来看每个软件系统，每个服务从容器的配对“提升”为一个软件系统。团队X的软件系统的系统上下文图现在如下所示：

[![](/images/microservices/8.png)](/images/microservices/8.png)

团队X只保留了单体UI，因此软件系统X的修订后的容器图如下所示：

[![](/images/microservices/9.png)](/images/microservices/9.png)

从团队A的角度来看，服务A的系统上下文图如下所示：

[![](/images/microservices/10.png)](/images/microservices/10.png)

服务A的容器图如下所示：

[![](/images/microservices/11.png)](/images/microservices/11.png)

## 总结

绘制微服务架构风格的图表的方法取决于各个服务的所有权，以及你是否将它们视为单个软件系统内的实现细节，还是由不同团队拥有的独立软件系统。